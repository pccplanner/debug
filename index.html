<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Script Manager with Preview</title>
  <!-- Include diff_match_patch if you want advanced word-level diffs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
  <style>
    /* Basic layout and styling from your V6.1 code (truncated for brevity) */
    body {
      margin: 0; padding: 0;
      background: #0d1117; color: #c9d1d9;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      display: flex; flex-direction: column;
      height: 100vh; overflow: hidden;
    }
    .header-section { /* ... */ }
    .toolbar { /* ... */ }
    .editor-wrapper { /* ... */ }
    .code-container { /* ... */ }
    .line-numbers { /* ... */ }
    .code-content { /* ... */ }
    textarea { /* ... */ }
    .splitter { /* ... */ }
    /* Diff View and Change List (hidden by default) */
    #diff-view, #change-list {
      position: fixed;
      top: 80px; /* or whatever fits your header */
      z-index: 300;
      display: none;
      overflow-y: auto;
    }
    #diff-view {
      right: 0; width: 40%; border-left: 2px solid #30363d; background: #0d1117; padding: 10px;
    }
    #change-list {
      left: 0; width: 15%; border-right: 2px solid #30363d; background: #161b22; padding: 10px;
    }
    .diff-line.added { background: rgba(39,174,96,0.2); }
    .diff-line.removed { background: rgba(248,81,73,0.2); }
    .change-item { cursor: pointer; margin: 5px 0; background: #21262d; }
    .change-item:hover { background: #2ea44f; }
  </style>
</head>
<body>

<div class="header-section">
  <h1>Script Manager Tool</h1>
  <!-- Hidden toolbar, search bar, etc. from your V6.1 code here... -->
  <button onclick="previewMerge()">Preview Merge</button>
  <button onclick="previewPatch()">Preview Patch</button>
</div>

<div class="editor-wrapper">
  <!-- Original Panel -->
  <div class="code-container" id="original-container">
    <div class="line-numbers" id="original-lines"></div>
    <div class="code-content">
      <textarea id="original"></textarea>
    </div>
  </div>
  <!-- Splitter -->
  <div class="splitter"></div>
  <!-- Patch Panel -->
  <div class="code-container" id="patch-container">
    <div class="line-numbers" id="patch-lines"></div>
    <div class="code-content">
      <textarea id="patch"></textarea>
    </div>
  </div>
</div>

<!-- Diff View & Change List -->
<div id="diff-view"></div>
<div id="change-list"></div>

<script>
/* ===================== BASIC LINE-NUMBER & SPLITTER LOGIC (like V6.1) ===================== */
function updateLineNumbers(id) {
  const ta = document.getElementById(id);
  const linesDiv = document.getElementById(id + "-lines");
  const lines = ta.value.split("\n");
  linesDiv.textContent = lines.map((_, i) => i + 1).join("\n");
}
function initSplitter() { /* same as your V6.1 code... */ }
/* etc. onload, scroll sync, etc. truncated for brevity */

/* ===================== DIFF + CHANGE LIST (line-based or diff_match_patch) ===================== */
// For simplicity, let's do a line-based diff. If you want word-level diffs, use diff_match_patch:
function lineDiff(orig, patch) {
  const origLines = orig.split("\n");
  const patchLines = patch.split("\n");
  let diff = [];
  let i = 0, j = 0;
  while (i < origLines.length && j < patchLines.length) {
    if (origLines[i] === patchLines[j]) {
      diff.push({ text: origLines[i], line: i+1, equal: true });
      i++; j++;
    } else {
      diff.push({ text: origLines[i], line: i+1, removed: true });
      diff.push({ text: patchLines[j], line: i+1, added: true });
      i++; j++;
    }
  }
  while (i < origLines.length) {
    diff.push({ text: origLines[i], line: i+1, removed: true });
    i++;
  }
  while (j < patchLines.length) {
    diff.push({ text: patchLines[j], line: origLines.length + j + 1, added: true });
    j++;
  }
  return diff;
}

// Show the diff in #diff-view and #change-list, and scroll Original to first difference
function showDiffAndScroll(origText, patchText) {
  const diff = lineDiff(origText, patchText);
  const diffView = document.getElementById("diff-view");
  const changeList = document.getElementById("change-list");
  diffView.innerHTML = "";
  changeList.innerHTML = "";

  let firstDiffLine = null;
  diff.forEach((d, idx) => {
    const lineDiv = document.createElement("div");
    lineDiv.className = "diff-line";
    if (d.added) {
      lineDiv.classList.add("added");
      lineDiv.textContent = "+ " + d.text;
    } else if (d.removed) {
      lineDiv.classList.add("removed");
      lineDiv.textContent = "- " + d.text;
    } else {
      lineDiv.textContent = "  " + d.text;
    }
    diffView.appendChild(lineDiv);

    if (d.added || d.removed) {
      if (firstDiffLine === null) {
        firstDiffLine = d.line;
      }
      const item = document.createElement("div");
      item.className = "change-item";
      item.textContent = `Line ${d.line}: ${d.added ? "Added" : "Removed"}`;
      item.onclick = () => scrollOriginalToLine(d.line);
      changeList.appendChild(item);
    }
  });

  // Show the overlays
  diffView.style.display = "block";
  changeList.style.display = "block";

  // Scroll original to the first difference, if any
  if (firstDiffLine) {
    scrollOriginalToLine(firstDiffLine);
  }
}

function scrollOriginalToLine(lineNum) {
  const ta = document.getElementById("original");
  // Each line ~21px in your code. Adjust as needed:
  ta.scrollTo({
    top: (lineNum - 1) * 21,
    behavior: "smooth"
  });
}

/* ===================== PREVIEW MERGE/PATCH, THEN CONFIRM ===================== */
function previewMerge() {
  const origText = document.getElementById("original").value;
  const patchText = document.getElementById("patch").value;
  // 1) Show diffs and navigate to first difference
  showDiffAndScroll(origText, patchText);
  // 2) Ask user if they want to proceed with the actual merge
  setTimeout(() => {
    if (confirm("Merge these changes into the Original script?")) {
      doMerge(); // call your actual merge function
    }
  }, 300);
}

function previewPatch() {
  const origText = document.getElementById("original").value;
  const patchText = document.getElementById("patch").value;
  // 1) Show diffs and navigate
  showDiffAndScroll(origText, patchText);
  // 2) Ask user if they want to proceed with the patch
  setTimeout(() => {
    if (confirm("Replace the Original with this Patch?")) {
      doPatch(); // call your actual patch function
    }
  }, 300);
}

function doMerge() {
  // This is your existing mergeScripts function
  const origLines = document.getElementById("original").value.split("\n");
  const patchLines = document.getElementById("patch").value.split("\n");
  const merged = origLines.map((line, i) => patchLines[i] || line).join("\n");
  document.getElementById("original").value = merged;
  document.getElementById("patch").value = "";
  // update lines, save history, etc...
  alert("Merge completed!");
}

function doPatch() {
  // This is your existing applyPatch function
  const patchText = document.getElementById("patch").value;
  document.getElementById("original").value = patchText;
  document.getElementById("patch").value = "";
  // update lines, save history, etc...
  alert("Patch applied!");
}
</script>
</body>
</html>