<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Load diff_match_patch library from CDN for advanced diff calculation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Script Manager Tool</title>
  <style>
    /* ================== GLOBAL STYLES ================== */
    body {
      margin: 0;
      padding: 0;
      background: #0d1117;
      color: #c9d1d9;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    h1 {
      font-size: 20px;
      text-align: center;
      margin: 10px 0;
    }
    /* ================== HEADER SECTION ================== */
    .header-section {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #0d1117;
      z-index: 100;
      padding: 10px;
      border-bottom: 1px solid #30363d;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #menu-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      font-size: 24px;
      color: #c9d1d9;
      cursor: pointer;
    }
    /* ================== SEARCH BAR ================== */
    .search-bar {
      width: 100%;
      max-width: 600px;
      display: flex;
      justify-content: center;
      padding: 5px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      margin-top: 5px;
    }
    .search-bar input {
      width: 100%;
      padding: 8px;
      background: #21262d;
      color: #c9d1d9;
      border: 1px solid #30363d;
      border-radius: 4px;
      font-size: 14px;
    }
    /* ================== TOOLBAR (HIDDEN BEHIND “…”) ================== */
    .toolbar {
      position: absolute;
      top: 60px;
      right: 10px;
      display: none;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px;
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      z-index: 200;
    }
    .toolbar label,
    .toolbar button {
      padding: 8px 12px;
      background: #238636;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .toolbar label:hover,
    .toolbar button:hover {
      background: #2ea44f;
    }
    .toolbar input[type="file"] {
      display: none;
    }
    /* ================== PROJECT MANAGEMENT (Custom Project Folder) ================== */
    .project-manager {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .project-manager input {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #30363d;
      border-radius: 4px;
      background: #21262d;
      color: #c9d1d9;
    }
    .project-manager button {
      padding: 8px 12px;
      background: #238636;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .project-manager button:hover {
      background: #2ea44f;
    }
    /* ================== EDITOR WRAPPER ================== */
    .editor-wrapper {
      flex: 1;
      margin-top: 120px; /* leave space for header */
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    /* ================== CODE CONTAINERS ================== */
    .code-container {
      display: flex;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 6px;
      position: relative;
      max-height: 100%;
      overflow: hidden;
    }
    /* Panels: Original and Patch take 50% each by default */
    #original-container,
    #patch-container {
      flex: 1 1 50%;
      min-height: 100px;
      overflow-y: auto;
      position: relative;
    }
    /* ================== PANEL TOOLBAR (Copy & Extra Buttons) ================== */
    .panel-toolbar {
      position: absolute;
      top: 5px;
      right: 5px;
      z-index: 2;
      background: transparent;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .copy-btn, .copyall-btn {
      background: transparent;
      border: none;
      font-size: 16px;
      color: #c9d1d9;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .copy-btn:hover, .copyall-btn:hover {
      color: #fff;
    }
    /* ================== LINE NUMBERS & TEXTAREA ================== */
    .line-numbers {
      width: 40px;
      background: #161b22;
      padding: 10px 5px;
      text-align: right;
      font-family: "SFMono-Regular", Consolas, monospace;
      font-size: 11px;
      color: #6e7681;
      line-height: 21px;
      border-right: 1px solid #30363d;
      position: sticky;
      left: 0;
      top: 0;
      z-index: 1;
      user-select: none;
      white-space: pre;
      overflow: hidden;
    }
    .code-content {
      flex: 1;
      position: relative;
      margin-left: 40px;
    }
    textarea {
      width: 100%;
      height: 100%;
      padding: 10px;
      font-family: "SFMono-Regular", Consolas, monospace;
      font-size: 14px;
      line-height: 21px;
      background: #21262d;
      color: #c9d1d9;
      border: none;
      box-sizing: border-box;
      resize: none;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    /* ================== SPLITTER ================== */
    .splitter {
      height: 5px;
      background: #30363d;
      cursor: ns-resize;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .splitter-handle {
      width: 40px;
      height: 5px;
      background: #8b949e;
      border-radius: 3px;
    }
    .splitter:hover .splitter-handle {
      background: #c9d1d9;
    }
    /* ================== ADVANCED DIFF & CHANGE LIST ================== */
    /* Diff View Overlay */
    #diff-view {
      position: fixed;
      top: 80px;
      right: 0;
      width: 40%;
      height: calc(100% - 80px);
      background: #0d1117;
      border-left: 2px solid #30363d;
      overflow-y: auto;
      padding: 10px;
      display: none;
      z-index: 300;
    }
    .diff-line {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      padding: 2px 4px;
    }
    .diff-line.added {
      background: rgba(39,174,96,0.2);
    }
    .diff-line.removed {
      background: rgba(248,81,73,0.2);
    }
    .diff-line.modified {
      background: rgba(255,204,0,0.2);
    }
    /* Change List Sidebar */
    #change-list {
      position: fixed;
      top: 80px;
      left: 0;
      width: 15%;
      height: calc(100% - 80px);
      background: #161b22;
      overflow-y: auto;
      padding: 10px;
      display: none;
      z-index: 300;
    }
    .change-item {
      padding: 4px 6px;
      margin: 4px 0;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      cursor: pointer;
    }
    .change-item:hover {
      background: #2ea44f;
    }
    /* ================== TOOLTIP FOR CHANGE PREVIEW ================== */
    .tooltip {
      position: absolute;
      background: #21262d;
      border: 1px solid #30363d;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      color: #c9d1d9;
      z-index: 400;
      white-space: pre-wrap;
      display: none;
    }
  </style>
</head>
<body>
  <!-- ================== HEADER SECTION ================== -->
  <div class="header-section">
    <h1>Script Manager Tool</h1>
    <div class="search-bar">
      <input type="text" id="search" placeholder="Search (supports regex)" oninput="searchInScript()">
    </div>
    <!-- “…” toggles toolbar -->
    <button id="menu-btn">⋮</button>
    <div class="toolbar">
      <label for="file-input-original">Load Original</label>
      <input type="file" id="file-input-original" accept=".txt" onchange="loadFileContent('original')">
      <label for="file-input-patch">Load Patch</label>
      <input type="file" id="file-input-patch" accept=".txt" onchange="loadFileContent('patch')">
      <button onclick="compareScripts()">Compare</button>
      <button onclick="applyPatch()">Apply Patch</button>
      <button onclick="mergeScripts()">Merge</button>
      <button onclick="clearContent()">Clear</button>
      <button onclick="saveProject()">Save</button>
      <button onclick="undo()">Undo</button>
    </div>
    <!-- Project Manager: Save as Project & List -->
    <div class="project-manager">
      <input type="text" id="project-name" placeholder="Project Name">
      <button onclick="saveProjectAs()">Save as Project</button>
      <select id="project-list" onchange="loadProjectByName(this.value)">
        <option value="">-- Select Project --</option>
      </select>
    </div>
  </div>
      margin-top: 15px;
  <!-- ================== MAIN EDITOR AREA ================== -->
  <div class="editor-wrapper">
    <!-- Original Panel -->
    <div class="code-container" id="original-container">
      <div class="panel-toolbar">
        <button class="copy-btn" onclick="copyPanel(this)">
          <!-- SVG icon for copy -->
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
               viewBox="0 0 16 16">
            <path d="M13 1H4a1 1 0 0 0-1 1v2h1V2h8v8h-1v1h2a1
                     1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
            <path d="M9 5H2a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h7a1
                     1 0 0 0 1-1V6a1 1 0 0 0-1-1z"/>
          </svg>
          <span>Copy</span>
        </button>
        <button class="copyall-btn" onclick="copyPatchToOriginal()">Copy from Patch</button>
      </div>
      <div class="line-numbers" id="original-lines"></div>
      <div class="code-content">
        <textarea id="original" placeholder="Paste your original script here..." oninput="updateLineNumbers('original')"></textarea>
      </div>
    </div>
    .summary-table {
    <!-- Splitter -->
    <div class="splitter">
      <div class="splitter-handle"></div>
    </div>
    .summary-table th, .summary-table td {
    <!-- Patch Panel -->
    <div class="code-container" id="patch-container">
      <div class="panel-toolbar">
        <button class="copy-btn" onclick="copyPanel(this)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
               viewBox="0 0 16 16">
            <path d="M13 1H4a1 1 0 0 0-1 1v2h1V2h8v8h-1v1h2a1
                     1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
            <path d="M9 5H2a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h7a1
                     1 0 0 0 1-1V6a1 1 0 0 0-1-1z"/>
          </svg>
          <span>Copy</span>
        </button>
      </div>
      <div class="line-numbers" id="patch-lines"></div>
      <div class="code-content">
        <textarea id="patch" placeholder="Paste your patch script here..." oninput="updateLineNumbers('patch')"></textarea>
      </div>
    </div>
  </div>
    }
  <!-- ================== ADVANCED DIFF VIEW & CHANGE LIST ================== -->
  <div id="diff-view"></div>
  <div id="change-list"></div>
  <!-- Tooltip for change preview -->
  <div id="tooltip" class="tooltip"></div>
    .summary-table .range-block {
  <script>
    /* ---------- Toolbar Toggle ---------- */
    document.getElementById("menu-btn").onclick = () => {
      const tb = document.querySelector(".toolbar");
      tb.style.display = tb.style.display === "flex" ? "none" : "flex";
    };
    .range-block .status-dot {
    /* ---------- Copy Functions ---------- */
    function copyPanel(btn) {
      const txt = btn.closest(".code-container").querySelector("textarea").value;
      navigator.clipboard.writeText(txt);
    }
    function copyPatchToOriginal() {
      const patchText = document.getElementById("patch").value;
      document.getElementById("original").value = patchText;
      updateLineNumbers("original");
    }
      color: #34495e;
    /* ---------- File Loading ---------- */
    function loadFileContent(panel) {
      const input = document.getElementById(`file-input-${panel}`);
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById(panel).value = e.target.result;
        updateLineNumbers(panel);
        saveToHistory();
      };
      reader.readAsText(file);
    }
    #adminTabs {
    /* ---------- Line Numbers & Scroll Sync ---------- */
    function updateLineNumbers(id) {
      const textarea = document.getElementById(id);
      const linesDiv = document.getElementById(id + "-lines");
      const lines = textarea.value.split("\n");
      let lineNums = "";
      for (let i = 1; i <= lines.length; i++) {
        lineNums += i + "\n";
      }
      linesDiv.textContent = lineNums;
      linesDiv.style.height = `${textarea.scrollHeight}px`;
      const scrollRatio = textarea.scrollTop / (textarea.scrollHeight - textarea.clientHeight || 1);
      linesDiv.scrollTop = scrollRatio * (linesDiv.scrollHeight - linesDiv.clientHeight || 1);
    }
    }
    /* ---------- Undo History ---------- */
    let history = [];
    function saveToHistory() {
      history.push({
        original: document.getElementById("original").value,
        patch: document.getElementById("patch").value,
      });
      if (history.length > 20) history.shift();
    }
    function undo() {
      if (history.length > 1) {
        history.pop();
        const prev = history[history.length - 1];
        document.getElementById("original").value = prev.original || "";
        document.getElementById("patch").value = prev.patch || "";
        updateLineNumbers("original");
        updateLineNumbers("patch");
      }
    }
  <!-- Login Section -->
    /* ---------- Search Functionality ---------- */
    function searchInScript() {
      const term = document.getElementById("search").value;
      const origText = document.getElementById("original").value;
      const index = origText.search(new RegExp(term, "i"));
      if (index >= 0) {
        const line = origText.substring(0, index).split("\n").length;
        scrollToLine(line);
      }
    }
    function scrollToLine(lineIndex) {
      const textarea = document.getElementById("original");
      textarea.scrollTop = (lineIndex - 1) * 21;
    }
  </div>
    /* ---------- Patch & Merge Functions ---------- */
    function applyPatch() {
      const patchText = document.getElementById("patch").value;
      if (patchText) {
        document.getElementById("original").value = patchText;
        document.getElementById("patch").value = "";
      }
      updateLineNumbers("original");
      updateLineNumbers("patch");
      saveToHistory();
      alert("Patch applied: Original script updated with Patch content.");
    }
    function mergeScripts() {
      const origLines = document.getElementById("original").value.split("\n");
      const patchLines = document.getElementById("patch").value.split("\n");
      const merged = origLines.map((line, i) => patchLines[i] || line).join("\n");
      document.getElementById("original").value = merged;
      document.getElementById("patch").value = "";
      updateLineNumbers("original");
      updateLineNumbers("patch");
      saveToHistory();
      alert("Merge completed: Original script merged with Patch.");
    }
    function clearContent() {
      document.getElementById("original").value = "";
      document.getElementById("patch").value = "";
      updateLineNumbers("original");
      updateLineNumbers("patch");
      saveToHistory();
    }
    function saveProject() {
      const data = {
        original: document.getElementById("original").value,
        patch: document.getElementById("patch").value,
      };
      localStorage.setItem("scriptProject", JSON.stringify(data));
      alert("Project Saved!");
    }
      </div>
    /* ---------- Splitter Functionality ---------- */
    let isResizing = false, startY, startHeightTop, startHeightBottom, splitter = null;
    function initSplitter() {
      splitter = document.querySelector(".splitter");
      splitter.addEventListener("mousedown", startResize);
      splitter.addEventListener("touchstart", startResize, { passive: false });
    }
    function startResize(e) {
      e.preventDefault();
      isResizing = true;
      startY = e.type === "touchstart" ? e.touches[0].clientY : e.clientY;
      const topPanel = document.getElementById("original-container");
      const bottomPanel = document.getElementById("patch-container");
      startHeightTop = topPanel.offsetHeight;
      startHeightBottom = bottomPanel.offsetHeight;
      window.addEventListener("mousemove", resizePanels);
      window.addEventListener("mouseup", stopResize);
      window.addEventListener("touchmove", resizePanels, { passive: false });
      window.addEventListener("touchend", stopResize);
    }
    function resizePanels(e) {
      if (!isResizing) return;
      e.preventDefault();
      const clientY = e.type === "touchmove" ? e.touches[0].clientY : e.clientY;
      const deltaY = clientY - startY;
      const topPanel = document.getElementById("original-container");
      const bottomPanel = document.getElementById("patch-container");
      const totalHeight = topPanel.offsetHeight + bottomPanel.offsetHeight;
      let newTopHeight = Math.max(100, Math.min(startHeightTop + deltaY, totalHeight - 100));
      let newBottomHeight = totalHeight - newTopHeight;
      topPanel.style.flex = `0 0 ${newTopHeight}px`;
      bottomPanel.style.flex = `0 0 ${newBottomHeight}px`;
    }
    function stopResize(e) {
      e.preventDefault();
      isResizing = false;
      window.removeEventListener("mousemove", resizePanels);
      window.removeEventListener("mouseup", stopResize);
      window.removeEventListener("touchmove", resizePanels);
      window.removeEventListener("touchend", stopResize);
    }

    /* ---------- Paste-Friendly Fix ---------- */
    function handlePaste(id) {
      setTimeout(() => {
        updateLineNumbers(id);
      }, 50);
    }
            <th>Admin</th>
    /* ---------- Advanced Diff Calculation Using diff_match_patch ---------- */
    function computeDiff() {
      const dmp = new diff_match_patch();
      const origText = document.getElementById("original").value;
      const patchText = document.getElementById("patch").value;
      const diffs = dmp.diff_main(origText, patchText);
      dmp.diff_cleanupSemantic(diffs);
      return diffs;
    }
    function showDiff() {
      const diffs = computeDiff();
      const diffView = document.getElementById("diff-view");
      diffView.innerHTML = "";
      let lineNum = 1;
      diffs.forEach((diff, index) => {
        const span = document.createElement("div");
        span.className = "diff-line";
        // diff[0]: -1 (delete), 0 (equal), 1 (insert)
        if (diff[0] === 1) {
          span.classList.add("added");
          span.textContent = "+ " + diff[1];
        } else if (diff[0] === -1) {
          span.classList.add("removed");
          span.textContent = "- " + diff[1];
        } else {
          span.textContent = "  " + diff[1];
        }
        // Set an id for navigation (approximate line number)
        span.id = "diff-line-" + lineNum;
        // Increase lineNum based on number of newline characters in diff text
        lineNum += (diff[1].match(/\n/g) || []).length;
        diffView.appendChild(span);
      });
      createChangeListFromDiff(diffs);
    }
    function createChangeListFromDiff(diffs) {
      const changeListDiv = document.getElementById("change-list");
      changeListDiv.innerHTML = "";
      let lineNum = 1;
      diffs.forEach((diff, index) => {
        if (diff[0] !== 0) {
          const item = document.createElement("div");
          item.className = "change-item";
          item.textContent = "Line " + lineNum + ": " + (diff[0] === 1 ? "Added" : "Removed");
          item.onclick = () => { scrollToLine(lineNum); };
          // Add hover preview tooltip
          item.onmouseover = (e) => showTooltip(e, diff[1]);
          item.onmouseout = hideTooltip;
          changeListDiv.appendChild(item);
        }
        lineNum += (diff[1].match(/\n/g) || []).length;
      });
    }
    function toggleDiffView(force) {
      const diffView = document.getElementById("diff-view");
      if (typeof force === "boolean") {
        diffView.style.display = force ? "block" : "none";
      } else {
        diffView.style.display = diffView.style.display === "block" ? "none" : "block";
      }
    }
    function toggleChangeList(force) {
      const changeList = document.getElementById("change-list");
      if (typeof force === "boolean") {
        changeList.style.display = force ? "block" : "none";
      } else {
        changeList.style.display = changeList.style.display === "block" ? "none" : "block";
      }
    }
          // Hide login, show container
    /* ---------- Tooltip for Change Preview ---------- */
    function showTooltip(event, text) {
      const tooltip = document.getElementById("tooltip");
      tooltip.textContent = text;
      tooltip.style.display = "block";
      tooltip.style.top = (event.clientY + 10) + "px";
      tooltip.style.left = (event.clientX + 10) + "px";
    }
    function hideTooltip() {
      const tooltip = document.getElementById("tooltip");
      tooltip.style.display = "none";
    }
    /* ===============================
    /* ---------- Compare, Patch, and Merge Actions ---------- */
    function compareScripts() {
      showDiff();
      toggleDiffView(true);
      toggleChangeList(true);
      saveToHistory();
    }
    function applyPatch() {
      const patchText = document.getElementById("patch").value;
      document.getElementById("original").value = patchText;
      document.getElementById("patch").value = "";
      updateLineNumbers("original");
      updateLineNumbers("patch");
      saveToHistory();
      alert("Patch applied: Original updated with Patch content.");
    }
    function mergeScripts() {
      // Use a basic merge: where patch text differs, use patch line.
      const origLines = document.getElementById("original").value.split("\n");
      const patchLines = document.getElementById("patch").value.split("\n");
      const merged = origLines.map((line, i) => patchLines[i] && patchLines[i] !== line ? patchLines[i] : line).join("\n");
      document.getElementById("original").value = merged;
      document.getElementById("patch").value = "";
      updateLineNumbers("original");
      updateLineNumbers("patch");
      saveToHistory();
      alert("Merge completed: Original merged with Patch.");
    }
        }
    /* ---------- Project Management (Save/Load Projects) ---------- */
    function saveProjectToLocalStorage() {
      const data = {
        original: document.getElementById("original").value,
        patch: document.getElementById("patch").value
      };
      localStorage.setItem("scriptProject", JSON.stringify(data));
    }
    function loadProjectFromLocalStorage() {
      const saved = localStorage.getItem("scriptProject");
      if (saved) {
        const { original, patch } = JSON.parse(saved);
        document.getElementById("original").value = original || "";
        document.getElementById("patch").value = patch || "";
      }
    }
    function saveProjectAs() {
      const projectName = document.getElementById("project-name").value.trim();
      if (!projectName) {
        alert("Please enter a project name.");
        return;
      }
      const data = {
        original: document.getElementById("original").value,
        patch: document.getElementById("patch").value
      };
      let projects = JSON.parse(localStorage.getItem("projects") || "{}");
      projects[projectName] = data;
      localStorage.setItem("projects", JSON.stringify(projects));
      alert("Project saved as " + projectName);
      populateProjectList();
    }
    function populateProjectList() {
      const projectList = document.getElementById("project-list");
      projectList.innerHTML = '<option value="">-- Select Project --</option>';
      const projects = JSON.parse(localStorage.getItem("projects") || "{}");
      for (let name in projects) {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        projectList.appendChild(option);
      }
    }
    function loadProjectByName(name) {
      if (!name) return;
      const projects = JSON.parse(localStorage.getItem("projects") || "{}");
      const data = projects[name];
      if (data) {
        document.getElementById("original").value = data.original || "";
        document.getElementById("patch").value = data.patch || "";
        updateLineNumbers("original");
        updateLineNumbers("patch");
      }
    }
       Render Calendar (Admin only)
    /* ---------- Auto-Save Every 10 Seconds ---------- */
    setInterval(() => {
      saveProjectToLocalStorage();
    }, 10000);

    /* ---------- Splitter Functionality ---------- */
    function initSplitter() {
      splitter = document.querySelector(".splitter");
      splitter.addEventListener("mousedown", startResize);
      splitter.addEventListener("touchstart", startResize, { passive: false });
    }
    function startResize(e) {
      e.preventDefault();
      isResizing = true;
      startY = e.type === "touchstart" ? e.touches[0].clientY : e.clientY;
      const topPanel = document.getElementById("original-container");
      const bottomPanel = document.getElementById("patch-container");
      startHeightTop = topPanel.offsetHeight;
      startHeightBottom = bottomPanel.offsetHeight;
      window.addEventListener("mousemove", resizePanels);
      window.addEventListener("mouseup", stopResize);
      window.addEventListener("touchmove", resizePanels, { passive: false });
      window.addEventListener("touchend", stopResize);
    }
    function resizePanels(e) {
      if (!isResizing) return;
      e.preventDefault();
      const clientY = e.type === "touchmove" ? e.touches[0].clientY : e.clientY;
      const deltaY = clientY - startY;
      const topPanel = document.getElementById("original-container");
      const bottomPanel = document.getElementById("patch-container");
      const totalHeight = topPanel.offsetHeight + bottomPanel.offsetHeight;
      let newTopHeight = Math.max(100, Math.min(startHeightTop + deltaY, totalHeight - 100));
      let newBottomHeight = totalHeight - newTopHeight;
      topPanel.style.flex = `0 0 ${newTopHeight}px`;
      bottomPanel.style.flex = `0 0 ${newBottomHeight}px`;
    }
    function stopResize(e) {
      e.preventDefault();
      isResizing = false;
      window.removeEventListener("mousemove", resizePanels);
      window.removeEventListener("mouseup", stopResize);
      window.removeEventListener("touchmove", resizePanels);
      window.removeEventListener("touchend", stopResize);
    }
          req.days.forEach(day => {
    /* ---------- Paste-Friendly Fix ---------- */
    function handlePaste(id) {
      setTimeout(() => {
        updateLineNumbers(id);
      }, 50);
    }
            }
    /* ---------- Initialization ---------- */
    window.onload = function() {
      loadProjectFromLocalStorage();
      ["original", "patch"].forEach((id) => {
        const ta = document.getElementById(id);
        ta.addEventListener("input", () => updateLineNumbers(id));
        ta.addEventListener("scroll", () => {
          const linesDiv = document.getElementById(id + "-lines");
          const ratio = ta.scrollTop / (ta.scrollHeight - ta.clientHeight || 1);
          linesDiv.scrollTop = ratio * (linesDiv.scrollHeight - linesDiv.clientHeight || 1);
        });
        ta.addEventListener("paste", () => handlePaste(id));
        updateLineNumbers(id);
      });
      initSplitter();
      populateProjectList();
    };
        grid.appendChild(cell);
    window.onbeforeunload = function() {
      saveProjectToLocalStorage();
    };
  </script>
</body>
</html>

    /* ===============================
       Load leaves from server
       =============================== */
    async function loadLeaves() {
      try {
        let url = `${API_BASE_URL}/api/get_leaves`;
        // If user, filter by staff ID on the backend
        if (userType === "user") {
          url += `?staffID=${currentStaffID}`;
        }
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Failed to fetch leaves');
        }
        requests = await response.json();
      } catch (error) {
        console.error("Error fetching leaves:", error);
        requests = [];
      }
    }

    /* ===============================
       Render Admin's Leave Requests
       =============================== */
    function groupRequestsByStaffID(requests) {
      const grouped = {};
      requests.forEach((req, reqIndex) => {
        const staffID = req.staffID;
        if (!grouped[staffID]) {
          grouped[staffID] = {
            staffName: req.staffName,
            staffID: staffID,
            requests: []
          };
        }
        grouped[staffID].requests.push({ ...req, originalIndex: reqIndex });
      });
      return Object.values(grouped);
    }

    function renderAdmin() {
      const adminList = document.getElementById("adminList");
      adminList.innerHTML = "";

      let filteredRequests = requests;

      if (userType === "user") {
        // Show only this user's requests
        filteredRequests = requests.filter(req => req.staffID === currentStaffID);
      } else if (userType === "admin") {
        // Filter out old requests
        const currentDate = new Date();
        const currentYearMonth = currentDate.getFullYear() * 12 + currentDate.getMonth();
        filteredRequests = requests.filter(req => {
          return req.days.some(day => {
            const [year, month] = day.date.split('-').map(Number);
            const requestYearMonth = year * 12 + (month - 1);
            return requestYearMonth >= currentYearMonth;
          });
        });
      }

      const groupedRequests = groupRequestsByStaffID(filteredRequests);

      groupedRequests.forEach((group, groupIndex) => {
        const item = document.createElement("div");
        item.className = "accordion-item";

        const totalDays = group.requests.reduce((sum, r) => sum + r.days.length, 0);
        const pendingCount = group.requests.reduce(
          (sum, r) => sum + r.days.filter(d => d.status === "Pending").length,
          0
        );

        item.innerHTML = `
          <div class="accordion-header" data-index="${groupIndex}">
            <span>${group.staffName} (${group.staffID})</span>
            <span class="badge ${pendingCount > 0 ? 'pending' : ''}">
              ${totalDays} days (${pendingCount} pending)
            </span>
          </div>
          <div class="accordion-content" data-index="${groupIndex}">
            ${group.requests.map((req, reqIdx) => `
              <div class="timeline">
                ${req.days.map((day, dayIndex) => `
                  <div class="day-block">
                    <span>${day.date}</span>
                    <div class="status-dot ${day.status.toLowerCase()}"></div>
                    <select data-group="${groupIndex}" data-req="${reqIdx}" data-day="${dayIndex}" ${userType === "user" ? "disabled" : ""}>
                      <option value="Pending"   ${day.status === "Pending"   ? "selected" : ""}>Pending</option>
                      <option value="Approved"  ${day.status === "Approved"  ? "selected" : ""}>Approved</option>
                      <option value="Rejected"  ${day.status === "Rejected"  ? "selected" : ""}>Rejected</option>
                      <option value="Write-in"  ${day.status === "Write-in"  ? "selected" : ""}>Write-in</option>
                    </select>
                  </div>
                `).join('')}
              </div>
            `).join('')}
            <div class="action-buttons">
              ${userType === "admin" ? `<button class="delete-btn" data-group="${groupIndex}">Delete</button>` : ''}
              <button class="whatsapp-btn" data-group="${groupIndex}">WhatsApp</button>
            </div>
          </div>
        `;
        adminList.appendChild(item);
      });

      // Accordion toggle
      adminList.querySelectorAll(".accordion-header").forEach(header => {
        const index = header.getAttribute("data-index");
        const content = header.nextElementSibling;

        if (openAccordions.has(index)) {
          content.style.display = "block";
        } else {
          content.style.display = "none";
        }

        header.onclick = function() {
          if (content.style.display === "block") {
            content.style.display = "none";
            openAccordions.delete(index);
          } else {
            content.style.display = "block";
            openAccordions.add(index);
          }
        };
      });

      // Update day status
      adminList.querySelectorAll("select").forEach(sel => {
        sel.onchange = async function() {
          if (userType !== "admin") return;
          const groupIndex = sel.getAttribute("data-group");
          const reqIndexWithinGroup = sel.getAttribute("data-req");
          const dayIndex = sel.getAttribute("data-day");
          const newStatus = sel.value;

          const group = groupedRequests[groupIndex];
          const req = group.requests[reqIndexWithinGroup];
          const day_id = req.days[dayIndex].id;
          if (!day_id) {
            alert("Error: Day ID missing. Check your DB data.");
            return;
          }

          try {
            const response = await fetch(`${API_BASE_URL}/api/update_day_status`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ day_id, status: newStatus })
            });
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.status === "success") {
              // reload leaves & calendar
              await loadLeaves();
              await renderCalendar();
              await renderMonthlySummary();
            } else {
              alert("Error: " + (data.message || "Unknown error"));
            }
          } catch (err) {
            console.error("Day status update error:", err);
            alert("Error updating day status: " + err.message);
          }
        };
      });

      // Delete entire requests
      adminList.querySelectorAll(".delete-btn").forEach(btn => {
        btn.onclick = async function() {
          if (userType !== "admin") return;
          const groupIndex = btn.getAttribute("data-group");
          const group = groupedRequests[groupIndex];

          openAccordions.delete(groupIndex);

          try {
            for (const req of group.requests) {
              const reqId = req.id;
              const response = await fetch(`${API_BASE_URL}/api/delete_request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ request_id: reqId })
              });
              const data = await response.json();
              if (data.status !== "success") {
                alert("Error deleting request: " + data.message);
                return;
              }
            }
            // Remove them from local array
            requests = requests.filter(r => r.staffID !== group.staffID);
            await renderCalendar();
          } catch (err) {
            console.error("Delete error:", err);
            alert("Error deleting. Please try again.");
          }
        };
      });

      // WhatsApp
      adminList.querySelectorAll(".whatsapp-btn").forEach(btn => {
        btn.onclick = function() {
          const groupIndex = btn.getAttribute("data-group");
          const group = groupedRequests[groupIndex];
          const msg = `Hello ${group.staffName} (${group.staffID}), your leave status:\n` +
            group.requests.map((req, i) =>
              `Request ${i+1}:\n` +
              req.days.map(d => `${d.date}: ${d.status}`).join('\n')
            ).join('\n\n');
          window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
        };
      });
    }

    /* ===============================
       Monthly Summary (Admin only)
       =============================== */
    async function renderMonthlySummary() {
      if (userType !== "admin") return;
      const summaryTableBody = document.getElementById("summaryTableBody");
      summaryTableBody.innerHTML = "";

      try {
        const response = await fetch(`${API_BASE_URL}/api/get_leaves`);
        if (!response.ok) {
          throw new Error('Failed to fetch leave requests');
        }
        const allRequests = await response.json();

        const monthStr = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}`;
        const allDaysByStaff = {};

        allRequests.forEach(req => {
          const staffID = req.staffID;
          const staffName = req.staffName;
          if (!allDaysByStaff[staffID]) {
            allDaysByStaff[staffID] = {
              staffName,
              staffID,
              days: {}
            };
          }
          req.days.forEach(day => {
            if (day.date.startsWith(monthStr) &&
               (day.status === "Approved" || day.status === "Write-in")) {
              // prefer "Approved" over "Write-in"
              if (!allDaysByStaff[staffID].days[day.date] || day.status === "Approved") {
                allDaysByStaff[staffID].days[day.date] = day.status;
              }
            }
          });
        });

        const groupedRequests = Object.values(allDaysByStaff).filter(g => Object.keys(g.days).length > 0);
        groupedRequests.forEach(group => {
          const dayEntries = Object.entries(group.days).map(([date, status]) => ({ date, status }));
          dayEntries.sort((a, b) => new Date(a.date) - new Date(b.date));

          // group consecutive days
          const ranges = [];
          let currentRange = [dayEntries[0]];
          for (let i = 1; i < dayEntries.length; i++) {
            const prevDate = new Date(currentRange[currentRange.length - 1].date);
            const currDate = new Date(dayEntries[i].date);
            if (daysBetween(prevDate, currDate) === 1 && currentRange[0].status === dayEntries[i].status) {
              currentRange.push(dayEntries[i]);
            } else {
              ranges.push(currentRange);
              currentRange = [dayEntries[i]];
            }
          }
          if (currentRange.length > 0) ranges.push(currentRange);

          const totalDays = dayEntries.length;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="staff-name">${group.staffName} (${group.staffID})</td>
            <td class="leave-range">
              ${ranges.map(range => {
                const startDate = range[0].date.split('-')[2];
                const endDate = range[range.length - 1].date.split('-')[2];
                const displayText = (startDate === endDate) ? startDate : `${startDate}-${endDate}`;
                const statusLabel = range[0].status;
                return `
                  <div class="range-block ${statusLabel.toLowerCase()}">
                    <span class="status-dot"></span>
                    ${displayText} (${statusLabel})
                  </div>
                `;
              }).join('')}
            </td>
            <td class="total-days">${totalDays}</td>
          `;
          summaryTableBody.appendChild(row);
        });

        if (summaryTableBody.children.length === 0) {
          const row = document.createElement("tr");
          row.innerHTML = `<td colspan="3" style="text-align: center; color: #7f8c8d; font-size: 11px;">
            No approved or write-in leave requests for this month.</td>`;
          summaryTableBody.appendChild(row);
        }
      } catch (error) {
        console.error("Error fetching monthly summary:", error);
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="3" style="text-align: center; color: #e74c3c; font-size: 11px;">
          Error loading summary. Please try again later.</td>`;
        summaryTableBody.appendChild(row);
      }
    }

    /* ===============================
       PDF Download (Optional)
       =============================== */
    async function downloadSummaryPDF() {
      if (userType !== "admin") return;
      alert("Implement your PDF logic here if needed!");
    }

    /* ===============================
       Team selection (Admin only)
       =============================== */
    async function selectTeam(num) {
      if (userType !== "admin") return;
      selectedTeam = num;
      await renderCalendar();
    }

    /* ===============================
       Submit new leave request
       =============================== */
    document.getElementById("leaveForm").onsubmit = async function(e) {
      e.preventDefault();
      const name  = document.getElementById("staffName").value.trim();
      const id    = document.getElementById("staffID").value.trim();
      const start = document.getElementById("startDate").value;
      const end   = document.getElementById("endDate").value;

      if (!name || !id || !start || !end) {
        alert("Please fill all fields.");
        return;
      }
      if (end < start) {
        alert("End date cannot be before start date.");
        return;
      }

      try {
        const response = await fetch(`${API_BASE_URL}/api/submit_leave`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            status: "Pending",
            staffName: name,
            staffID: id,
            fromDate: start,
            toDate: end
          })
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("Leave request submitted successfully.");
          await loadLeaves();
          if (userType === "admin") {
            await renderCalendar();
          } else {
            renderAdmin();
          }
        } else {
          alert("Error: " + data.message);
        }
      } catch (error) {
        console.error("Error submitting leave request:", error);
        alert("An error occurred. Please try again later.");
      }

      e.target.reset();
    };

    /* ===============================
       Prev/Next month (Admin only)
       =============================== */
    async function prevMonth() {
      if (userType !== "admin") return;
      currentMonth--;
      if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      await renderCalendar();
    }

    async function nextMonth() {
      if (userType !== "admin") return;
      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
      await renderCalendar();
    }

    /* ===============================
       Keep end date in same month
       =============================== */
    document.getElementById("startDate").addEventListener("change", function() {
      const startDateValue = this.value;
      const endDateInput = document.getElementById("endDate");
      if (startDateValue) {
        endDateInput.min = startDateValue;
        endDateInput.value = "";
      } else {
        endDateInput.min = "";
        endDateInput.value = "";
      }
    });

    /* ===============================
       Show/hide panels for admin
       =============================== */
    function showLeaveManagement() {
      document.getElementById("leaveManagementPanel").style.display = "block";
      document.getElementById("userManagementPanel").style.display = "none";
    }
    function showUserManagement() {
      document.getElementById("leaveManagementPanel").style.display = "none";
      document.getElementById("userManagementPanel").style.display = "block";
      loadUsers();
    }

    /* ===============================
       User Management (Only staffID)
       =============================== */
    const USERS_API_URL = API_BASE_URL + "/api/users";

    // -------------------------------
    // Updated in v5.1: Add New Username Field
    // -------------------------------
    // Handle adding a new user (now including username)
    document.getElementById("addUserForm").onsubmit = async function(e) {
      e.preventDefault();

      // NEW/UPDATED: Now we also read the 'username' input
      const newUsername = document.getElementById("newUsername").value.trim();
      const newStaffID  = document.getElementById("newStaffID").value.trim();
      const newPassword = document.getElementById("newPassword").value;
      const newIsAdmin  = document.getElementById("newIsAdmin").checked;

      // Make sure 'username' is also required
      if (!newUsername || !newStaffID || !newPassword) {
        alert("Please fill in Username, Staff ID, and Password.");
        return;
      }

      // Hash the password via SHA-256 (as before)
      const hashedPassword = await hashPassword(newPassword);

      try {
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({
            // NEW/UPDATED: Pass 'username' to the backend
            username: newUsername,
            staffID: newStaffID,
            password: hashedPassword,
            isAdmin: newIsAdmin
          })
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("User added successfully.");
          document.getElementById("addUserForm").reset();
          loadUsers();  // reload user list
        } else {
          alert("Error adding user: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        alert("Error adding user: " + err.message);
      }
    };

    // Load user list (admin only)
    async function loadUsers() {
      try {
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });
        if (!response.ok) throw new Error("Failed to fetch users");
        const users = await response.json();

        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = "";
        users.forEach(user => {
          const tr = document.createElement("tr");
          // NEW/UPDATED: Insert username into its own column
          tr.innerHTML = `
            <td>${user.username}</td>
            <td>${user.staffID}</td>
            <td>${user.isAdmin ? "Yes" : "No"}</td>
            <td>
              <button onclick="deleteUser('${user.id}')">Delete</button>
              <button onclick="toggleAdminStatus('${user.id}', ${user.isAdmin})">
                ${user.isAdmin ? "Revoke Admin" : "Make Admin"}
              </button>
              <button onclick="resetUserPasswordPrompt('${user.id}')">Reset Password</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        alert("Error loading users: " + err.message);
      }
    }

    // Delete user
    async function deleteUser(id) {
      if (!confirm("Are you sure you want to delete this user?")) return;
      try {
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL + "/" + id, {
          method: "DELETE",
          headers: {
            "Authorization": "Bearer " + token
          }
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("User deleted successfully.");
          loadUsers();
        } else {
          alert("Error deleting user: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        alert("Error deleting user: " + err.message);
      }
    }

    // Toggle admin status
    async function toggleAdminStatus(id, isCurrentlyAdmin) {
      try {
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL + "/" + id + "/toggle_admin", {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token
          }
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("Admin status updated successfully.");
          loadUsers();
        } else {
          alert("Error toggling admin status: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        alert("Error toggling admin status: " + err.message);
      }
    }

    // Reset user password
    function resetUserPasswordPrompt(id) {
      const newPassword = prompt("Enter new password:");
      if (newPassword) {
        resetUserPassword(id, newPassword);
      }
    }
    async function resetUserPassword(id, password) {
      try {
        const hashedPassword = await hashPassword(password);
        const token = localStorage.getItem('token') || '';
        const response = await fetch(USERS_API_URL + "/" + id + "/reset_password", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ newPassword: hashedPassword })
        });
        const data = await response.json();
        if (data.status === "success") {
          alert("Password reset successfully.");
        } else {
          alert("Error resetting password: " + (data.message || "Unknown error"));
        }
      } catch (err) {
        alert("Error resetting password: " + err.message);
      }
    }

    // Hash password using SHA-256 (Web Crypto)
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest("SHA-256", data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
      return hashHex;
    }

    /* ===============================
       On page load
       =============================== */
    document.addEventListener("DOMContentLoaded", () => {
      // Show login, hide container
      document.getElementById("loginSection").style.display = "block";
      document.querySelector(".container").style.display = "none";
    });
  </script>
</body>
</html>